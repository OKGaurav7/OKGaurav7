# Open the Excel file
wb = load_workbook(output_filename)
ws = wb.active

# Set header cells background color to RGB value (192, 0, 0)
header_fill = PatternFill(start_color="C00000", end_color="C00000", fill_type="solid")
header_font = Font(color="FFFFFF", bold=True)  # Set font color to white and bold
for cell in ws[1]:
    cell.fill = header_fill
    cell.font = header_font

# Set conditional formatting color to RGB value (255, 199, 206)
condition_fill = PatternFill(start_color="FFC7CE", end_color="FFC7CE", fill_type="solid")

# Add cell borders to all cells
border = Border(left=Side(border_style='thin', color='000000'),
                right=Side(border_style='thin', color='000000'),
                top=Side(border_style='thin', color='000000'),
                bottom=Side(border_style='thin', color='000000'))

for row in ws.iter_rows():
    for cell in row:
        cell.border = border
        cell.alignment = Alignment(horizontal='right')  # Align cell content to the right

# Loop through columns 'Vd' to 'Vd>7' and apply condition_fill if value > 0
for col_index in range(new_excel_df.columns.get_loc('Vd'), new_excel_df.columns.get_loc('Vd>7') + 1):
    for i, value in enumerate(new_excel_df.iloc[:, col_index], start=2):
        cell = ws.cell(row=i, column=col_index + 1)
        if value > 0:
            cell.fill = condition_fill

# Overall Economic Impact column
for i, value in enumerate(new_excel_df['Overall Economic Impact'], start=2):
    cell = ws.cell(row=i, column=new_excel_df.columns.get_loc('Overall Economic Impact') + 1)
    if value < 0:
        cell.fill = condition_fill
        cell.value='('+str(abs(value))+')'
    else:
        #do not fill
        pass

# Loop through all cells to set font color
for row in ws.iter_rows():
    for cell in row:
        if cell.fill == header_fill:
            cell.font = header_font
        elif cell.fill == condition_fill:
            cell.font = Font(color="C00000")  # Set font color to red

# Apply header style to the cell containing 'Total' in the 'Vd>7' column
vd_gt_7_total_cell = ws.cell(row=len(new_excel_df) + 1, column=new_excel_df.columns.get_loc('Vd>7') + 1)
vd_gt_7_total_cell.fill = header_fill
vd_gt_7_total_cell.font = header_font

# Apply header style to cells containing sum of total fails and overall economic impact
total_fails_cell = ws.cell(row=len(new_excel_df) + 1, column=new_excel_df.columns.get_loc('Total Fails') + 1)
overall_impact_cell = ws.cell(row=len(new_excel_df) + 1, column=new_excel_df.columns.get_loc('Overall Economic Impact') + 1)

total_fails_cell.fill = header_fill
total_fails_cell.font = header_font

overall_impact_cell.fill = header_fill
overall_impact_cell.font = header_font

# Set column width to fit the content optimally
for column in ws.columns:
    max_length = 0
    column_values = [cell.value for cell in column]
    max_length = max(len(str(cell)) for cell in column_values if cell is not None)
    column_letter = column[0].column_letter
    ws.column_dimensions[column_letter].width = max_length + 2  # Adding some extra space

# Save the modified Excel file
wb.save(output_filename)

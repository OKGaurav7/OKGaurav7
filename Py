import os
import win32com.client
import zipfile
import datetime

# Specify the folder to save extracted Excel files
save_folder = "C:\\Path\\To\\Save\\Excel\\Files\\"

# Create the Outlook application object
outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")

# Get the Inbox folder
inbox = outlook.GetDefaultFolder(6)

# Get current time
current_time = datetime.datetime.now()

# Calculate time 15 minutes ago
time_15_minutes_ago = current_time - datetime.timedelta(minutes=15)

# Iterate through all items in the Inbox received in the last 15 minutes
for message in inbox.Items.Restrict("[ReceivedTime] >= '" + time_15_minutes_ago.strftime('%m/%d/%Y %H:%M:%S') + "'"):
    # Check if the message has attachments
    if message.Attachments.Count > 0:
        for attachment in message.Attachments:
            # Check if the attachment is a zip file
            if attachment.FileName.lower().endswith('.zip'):
                # Save the attachment to a temporary folder
                attachment.SaveAsFile(os.path.join(os.getcwd(), 'temp.zip'))

                # Extract the Excel files from the zip archive
                with zipfile.ZipFile('temp.zip', 'r') as zip_ref:
                    for file_name in zip_ref.namelist():
                        if file_name.lower().endswith('.xlsx') or file_name.lower().endswith('.xls'):
                            zip_ref.extract(file_name, save_folder)

                # Delete the temporary zip file
                os.remove('temp.zip')

import win32com.client as client
import os
import pathlib
from PIL import ImageGrab

# Get the current working directory
cwd = os.getcwd()

# Define the path to the output Excel file
workbook_path = os.path.join(cwd, 'output.xlsx')

# Open Excel application
excel = client.Dispatch('Excel.Application')
wb = excel.Workbooks.Open(workbook_path)

# Copy data from different sheets and save them as images
sheet0 = wb.Sheets['Buy Data']
buy_data_count = 10  # Example value, replace with your actual count
copyrange = sheet0.Range('A1:R' + str(buy_data_count + 1))
copyrange.CopyPicture(Appearance=1, Format=2)
ImageGrab.grabclipboard().save('paste0.png')

sheet1 = wb.Sheets['Sell Data']
sell_data_count = 10  # Example value, replace with your actual count
copyrange = sheet1.Range('A1:R' + str(sell_data_count + 1))
copyrange.CopyPicture(Appearance=1, Format=2)
ImageGrab.grabclipboard().save('paste1.png')

sheet2 = wb.Sheets['New Data']
new_data_count = 10  # Example value, replace with your actual count
copyrange = sheet2.Range('A1:K' + str(new_data_count + 1))
copyrange.CopyPicture(Appearance=1, Format=2)
ImageGrab.grabclipboard().save('paste2.png')

# Define paths to image files
data0_path = pathlib.Path('paste0.png')
data1_path = pathlib.Path('paste1.png')
data2_path = pathlib.Path('paste2.png')

# Get absolute paths to image files
data0_absolute = str(data0_path.absolute())
data1_absolute = str(data1_path.absolute())
data2_absolute = str(data2_path.absolute())

# Create Outlook application instance
outlook = client.Dispatch('Outlook.Application')
message = outlook.CreateItem(0)
message.To = "rohit.patil@nomura.com"
message.Subject = "Fails Update 12-Apr-2024"

# Attach images to the email
image0 = message.Attachments.Add(data0_absolute)
image1 = message.Attachments.Add(data1_absolute)
image2 = message.Attachments.Add(data2_absolute)

# Define HTML body of the email
html_body = """
  <div>
  <p>Hi Team,</p> 
  <p>Please find below the updated summary of the failed trades, CBBT is used as a pricing source: </p>
  </div><br>
      <div>
    <img src="cid:paste2-img" width=80%>
      </div><br>
      
      <div>
      <p>Failed trades where Nomura is short to receive in more detail (with current exposure). </p><br>
    <img src="cid:paste0-img" width=250%>
      </div><br>
      
  <div>
  <p>And failed trades where Nomura is short to deliver (with current exposure). </p>
    <img src="cid:paste1-img" width=250%>
  </div><br>
  <br>
  <br>
  <p>Thanks,</p>
  <p>Rohit</p>
"""

# Set image IDs in the email
image0.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001F", "paste0-img")
image1.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001F", "paste1-img")
image2.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001F", "paste2-img")

# Attach the Excel file to the email with the specified display name
output_excel = message.Attachments.Add(workbook_path)
output_excel.DisplayName = "Daily Fails AO"

# Set HTML body and display the email
message.HTMLBody = html_body
message.Display()

import win32com.client as client
import os
import pathlib
from PIL import ImageGrab

workbook_path = os.getcwd() + '\\output.xlsx'
excel = client.Dispatch('Excel.Application')
wb = excel.Workbooks.Open(workbook_path)

# Define the sheet names and their corresponding counts
sheet_names_counts = [('Buy Data', buy_data_count), ('Sell Data', sell_data_count), ('New Data', new_data_count)]

attachments = []

for sheet_name, data_count in sheet_names_counts:
    sheet = wb.Sheets[sheet_name]
    copy_range = sheet.Range('A1:R' + str(data_count + 1))
    copy_range.CopyPicture(Appearance=1, Format=2)
    ImageGrab.grabclipboard().save(f'paste_{sheet_name}.png')
    image_path = pathlib.Path(f'paste_{sheet_name}.png')
    attachments.append(str(image_path.absolute()))

data_attachments = []

for attachment in attachments:
    data_attachment = message.Attachments.Add(attachment)
    data_attachment.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001F", f"{attachment}-img")
    data_attachments.append(data_attachment)

html_body = """
  <div>
  <p>Hi Team,</p> 
  <p>Please find below the updated summary of the failed trades, CBBT is used as a pricing source: </p>
  </div><br>
"""

for sheet_name, _ in sheet_names_counts:
    html_body += f"""
    <div>
    <p>Failed trades in {sheet_name} (with current exposure). </p><br>
    <img src="cid:paste_{sheet_name}.png-img" width=80%>
    </div><br>
    """

html_body += """
  <br>
  <p>Thanks,</p>
  <p>Rohit</p>
"""

message.HTMLBody = html_body
message.Display()

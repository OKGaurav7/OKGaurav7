import os
import glob
import pandas as pd
import xlwings as xw

def get_latest_file(directory, extension):
    # Get the list of files with the specified extension in the directory
    files = glob.glob(os.path.join(directory, f'*.{extension}'))
    
    # Sort files by modification time
    latest_file = max(files, key=os.path.getmtime)
    
    return latest_file

def generate_output(master_path, takara_path, prodman_path):
    # Function to generate the output Excel file

    # Read data from master.xlsx, Takara.xlsx, and prodman.xlsx
    master = pd.read_excel(master_path)
    Takara = pd.read_excel(takara_path)
    prodman = pd.read_excel(prodman_path)

    # Your existing code for merging and processing the data goes here

    output_filename = 'output.xlsx'

    # Write data to Excel file
    with pd.ExcelWriter(output_filename) as writer:
        output_df.to_excel(writer, index=False, sheet_name='All Data')

        # Filter data where operation type is Buy
        buy_df = output_df[output_df['Operation Type'].str.contains('BUY')]
        buy_df.to_excel(writer, index=False, sheet_name='Buy Data')

        # Filter data where operation type is Sell
        sell_df = output_df[output_df['Operation Type'].str.contains('SELL')]
        sell_df.to_excel(writer, index=False, sheet_name='Sell Data')

    # Run the VBA script on the output Excel file
    run_vba_script(output_filename, vba_script)

def generate_new_excel():
    # Function to generate the new Excel sheet

    # Your existing code for generating new data and adding it to the Excel file goes here

def run_vba_script(file_path, vba_script):
    # Connect to the Excel application
    app = xw.App()

    # Open the Excel file
    wb = app.books.open(file_path)

    # Run the VBA script
    wb.app.execute_vba(vba_script)

    # Save and close the Excel file
    wb.save()
    wb.close()

    # Quit the Excel application
    app.quit()

# Example VBA script to activate the "G" column and select all values from row 2 onwards
vba_script = """
Sub ActivateColumnG()
    Dim ws As Worksheet
    For Each ws In Worksheets
        ws.Columns("G:G").Activate
        ws.Range("G2", ws.Range("G2").End(xlDown)).Select
    Next ws
End Sub
"""

# Example usage:
directory = '/path/to/directory'
extension = 'xlsx'
master_path = get_latest_file(directory, extension)
takara_path = '/path/to/Takara.xlsx'
prodman_path = '/path/to/prodman.xlsx'

generate_output(master_path, takara_path, prodman_path)
generate_new_excel()
